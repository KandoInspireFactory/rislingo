# Azure Web App デプロイ完全ガイド (Rislingo)

作成日: 2025年12月16日
対象プロジェクト: Rislingo (Next.js + FastAPI + Neon DB + Azure OpenAI)

このドキュメントは、本プロジェクトをゼロからAzure Web Appへデプロイし、稼働状態にするための完全な手順書です。数多くのトラブルシューティングを経て確立された「正解ルート」を記載しています。

---

## 1. 全体構成と前提

### アーキテクチャ
*   **リポジトリ**: モノレポ構成（ルート直下に `backend/` と `frontend/`）
*   **バックエンド**: Azure Web App (Linux) / Python 3.12 / FastAPI
*   **フロントエンド**: Azure Web App (Linux) / Node.js 20 / Next.js (App Router)
*   **データベース**: Neon (PostgreSQL)
*   **AI**: Azure OpenAI Service (GPT-4, Whisper, TTS)

---

## 2. バックエンド (Backend) デプロイ手順

### 2.1 Azureリソースの作成
1.  **Azure Portal** で「Web App」を作成する。
    *   **名前**: (例: `tech0-gen-11-step3-2-py-24`)
    *   **公開**: コード
    *   **ランタイム スタック**: **Python 3.12**
    *   **オペレーティング システム**: **Linux**
    *   **地域**: Japan East (推奨)

### 2.2 コードベースの必須修正
デプロイ前に以下の修正がコードに含まれていることを確認する。

1.  **Azure OpenAI 対応 (`backend/services/openai_client.py`)**
    *   `openai` ライブラリの `AsyncAzureOpenAI` を使用するように修正。
    *   環境変数 `AZURE_OPENAI_API_KEY` が存在する場合、Azureクライアントを初期化するロジックを追加。

2.  **環境変数チェックの緩和 (`backend/main.py`)**
    *   起動時に `OPENAI_API_KEY` または `AZURE_OPENAI_API_KEY` の**どちらか**があればOKとするように修正（以前は `OPENAI_API_KEY` 必須で落ちていた）。

3.  **CORS設定 (`backend/main.py`)**
    *   `ALLOWED_ORIGINS` 環境変数からリストを取得し、`CORSMiddleware` に渡す実装になっていることを確認。

### 2.3 Azure Portal 設定 (Configuration)

**【環境変数 (Environment variables)】**
以下の変数を設定する。

| 名前 | 値の例/説明 |
| :--- | :--- |
| `AZURE_OPENAI_API_KEY` | (Azure OpenAIのキー) |
| `AZURE_OPENAI_ENDPOINT` | `https://(resource-name).cognitiveservices.azure.com/` |
| `AZURE_API_VERSION` | `2024-12-01-preview` |
| `AZURE_GPT_DEPLOYMENT` | `gpt-5-chat` (デプロイ名) |
| `AZURE_WHISPER_DEPLOYMENT` | `whisper` (デプロイ名) |
| `AZURE_TTS_DEPLOYMENT` | `tts` (デプロイ名) |
| `DATABASE_URL` | `postgres://user:pass@host/db` (Neon接続文字列) |
| `WEBSITES_PORT` | `8000` (FastAPIのポート) |
| `SCM_DO_BUILD_DURING_DEPLOYMENT` | `true` (**重要**: これがないと依存関係がインストールされない) |
| `ALLOWED_ORIGINS` | `*` (開発中はこれ推奨。本番はフロントエンドURLを指定) |

**【全般設定 (General settings)】**
*   **スタートアップ コマンド (Startup Command)**:
    ```bash
    gunicorn --bind 0.0.0.0:8000 --worker-class uvicorn.workers.UvicornWorker --workers 4 --timeout 600 main:app
    ```
    *   **注意**: GitHub Actionsからは設定できないため、必ずポータルで設定して保存すること。

### 2.4 GitHub Actions ワークフロー設定
**ファイル名**: `.github/workflows/main_tech0-gen-11-step3-2-py-24.yml` (例)

**重要な設定ポイント**:
1.  **パスのフラット化**: `backend/` フォルダごとアップロードするとパスがずれるため、ビルド時に中身を一時フォルダ (`deployment_package`) にコピーし、それをルートとしてアップロードする。
2.  **仮想環境の除外**: ローカルで作成した `venv` (`antenv`) はアップロード**しない**（Linux上でのパスが壊れるため）。
3.  **Oryxビルドの利用**: Azure側で `requirements.txt` を検知させ、自動で依存関係をインストールさせる。

---

## 3. フロントエンド (Frontend) デプロイ手順

### 3.1 Azureリソース作成
1.  **Azure Portal** で「Web App」を作成する（Static Web Appsではない）。
    *   **名前**: (例: `tech0-gen-11-step3-2-node-24`)
    *   **ランタイム スタック**: **Node 20 LTS**
    *   **オペレーティング システム**: **Linux**

### 3.2 コードベースの必須修正
Next.jsをAzure Web Appで確実に動かすための重要な設定。

1.  **Standaloneモード & 出力先変更 (`frontend/next.config.ts`)**
    ```typescript
    const nextConfig: NextConfig = {
      output: "standalone", // 必須: 依存関係をまとめる
      distDir: "build",     // 必須: .next(隠しフォルダ)のデプロイ漏れを防ぐ
    };
    ```

2.  **Git追跡の修正 (`.gitignore`)**
    *   デフォルトで `lib/` が無視されている場合があるため、`!frontend/lib/` を追記して `api-client.ts` 等がアップロードされるようにする。

3.  **ビルドエラー対策**
    *   `frontend/eslint.config.mjs`: `any` 型や `unused-vars` のルールを `off` に緩和する。
    *   `frontend/lib/types.ts`: 不足している型定義（`SessionDetailResponse` 等）を追加する。

### 3.3 Azure Portal 設定 (Configuration)

**【環境変数 (Environment variables)】**
| 名前 | 値の例/説明 |
| :--- | :--- |
| `NEXT_PUBLIC_API_URL` | バックエンドのURL (ビルド時には使われないが念のため) |
| `SCM_DO_BUILD_DURING_DEPLOYMENT` | `false` または削除 (GitHub Actionsでビルド済みを送るため不要) |
| `PORT` | `8080` (Azureのデフォルト待機ポート) |

**【全般設定 (General settings)】**
*   **スタートアップ コマンド (Startup Command)**:
    ```bash
    node server.js
    ```
    *   Next.jsのStandaloneモードでは `npm start` ではなくこれを使う。

### 3.4 GitHub Actions ワークフロー設定
**ファイル名**: `.github/workflows/main_tech0-gen-11-step3-2-node-24.yml` (例)

**重要な設定ポイント**:
1.  **ビルド時の環境変数注入**:
    *   `NEXT_PUBLIC_` 変数はビルド時に埋め込まれるため、**GitHub Actionsの `run: npm run build` ステップで `env` を指定する**。
    ```yaml
    - name: Build Next.js application
      run: npm run build
      env:
        NEXT_PUBLIC_API_URL: https://tech0-gen-11-step3-2-py-24.azurewebsites.net
    ```
2.  **パッケージング**:
    *   `frontend/build/standalone` の中身をデプロイパッケージのルートにコピーする。
    *   静的ファイル (`build/static` -> `build/standalone/build/static`) と `public` フォルダも忘れずにコピーして同梱する。

---

## 4. トラブルシューティング・ナレッジ

### Q1. デプロイ後に「:( Application Error」が出る
*   **原因**: 必要なファイル（特に `.next` や `server.js`）が見つからない、または起動コマンドが間違っている。
*   **解決策**:
    *   `next.config.ts` で `distDir: "build"` を設定し、隠しフォルダ問題を回避しているか確認。
    *   スタートアップコマンドが `node server.js` になっているか確認。
    *   ログストリームで `Error: Could not find a production build...` が出ていれば、フォルダ構成ミス。

### Q2. ログイン時に「Failed to fetch」になる
*   **原因**: CORSエラー、または環境変数の埋め込みミス。
*   **解決策**:
    *   **CORS**: バックエンドの `ALLOWED_ORIGINS` を `*` にして試す。URL指定の場合は末尾スラッシュの有無 (`/`) が一致していない可能性がある。
    *   **環境変数**: フロントエンドのGitHub Actionsのビルドステップで `NEXT_PUBLIC_API_URL` が正しく設定されているか確認。Azure Portalで設定してもクライアント側には反映されない。

### Q3. 「サーバーエラー」や「401 Unauthorized」が頻発する
*   **原因**: バックエンドがインメモリ (`session_store = {}`) でセッションを管理している場合、**デプロイや設定変更で再起動すると全ユーザーがログアウトされる**。
*   **解決策**: (2025/12/17対応済み) セッション情報をデータベース (`sessions` テーブル) に保存するように修正したため、サーバー再起動後もログイン状態は維持されるようになった。
    *   もし発生する場合は、クライアント側のトークン切れか、DB接続エラーの可能性がある。

---

## 5. 運用フロー (再デプロイ時)
*   **原因**: `frontend/lib/` などのファイルが `.gitignore` ルールで無視され、Gitに上がっていない。
*   **解決策**: `.gitignore` に `!frontend/lib/` を追加し、`git add` してコミットする。

---

## 5. 運用フロー (再デプロイ時)

コードを修正して再デプロイする場合：

1.  ローカルで変更をコミットし、`git push` する。
2.  GitHub Actionsが自動的に動き、ビルド・デプロイを行う。
3.  **注意**:
    *   バックエンドの設定（環境変数など）を変更した場合は、Azure Portalで「再起動」が必要。
    *   フロントエンドの `NEXT_PUBLIC_` 変数を変えたい場合は、GitHub Actionsのワークフローファイルを修正してプッシュし直す必要がある（再ビルドが必要なため）。
