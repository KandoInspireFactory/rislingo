# Rislingo アプリケーション仕様書 (2025-12-16版)

## 1. システム構成図

### 1.1 インフラアーキテクチャ
本アプリケーションは、Microsoft Azure上で稼働するWebアプリケーションです。

*   **フロントエンド**: Azure Web App (Linux / Node.js 20)
    *   フレームワーク: Next.js (App Router)
    *   デプロイ方式: GitHub Actions (Standalone Build)
*   **バックエンド**: Azure Web App (Linux / Python 3.12)
    *   フレームワーク: FastAPI
    *   デプロイ方式: GitHub Actions (Oryx Build)
*   **データベース**: Neon (PostgreSQL互換)
*   **AIサービス**: Azure OpenAI Service (GPT-4, Whisper, TTS)

### 1.2 処理フロー (基本)
1.  ユーザーがフロントエンドにアクセスし、ログインする。
2.  フロントエンドからバックエンドAPIを呼び出し、問題生成や音声処理を行う。
3.  バックエンドはAzure OpenAIと連携し、AI生成コンテンツや採点結果を返す。
4.  結果はNeonデータベースに保存される。

## 2. 機能要件

### 2.1 機能一覧
| カテゴリ | 機能名 | 詳細 |
| :--- | :--- | :--- |
| **認証** | 簡易ログイン | メールアドレス（ユーザーID）のみによる簡易認証。セッションはデータベース (`sessions` テーブル) で永続化管理（サーバー再起動でも維持される）。 |
| **練習** | 問題自動生成 | Task 1〜4に対応。Azure OpenAI (GPT-4) を使用して問題を動的に生成。 |
| | Reading機能 | 制限時間付きテキスト表示。 |
| | Listening機能 | 講義スクリプトの音声再生 (Azure OpenAI TTS)。 |
| | 録音機能 | ブラウザ上での音声録音。 |
| **評価** | AI文字起こし | 録音データをテキスト化 (Azure OpenAI Whisper)。 |
| | AI採点 | TOEFL採点基準に基づきスコア(0-4)算出、改善点指摘、模範解答生成。 |
| **復習** | 学習履歴 | 過去の練習結果（音声、スコア、フィードバック）の一覧・詳細表示。 |
| | フレーズ保存 | 有用な表現を保存する機能。 |

## 3. コードとエンドポイント対応表 (最新)

### 3.1 フロントエンドとバックエンドの接続

| 機能 | Frontend Component | Backend API Endpoint | 備考 |
| :--- | :--- | :--- | :--- |
| **ログイン** | `api-client.ts` | **`/api/auth/simple-login`** | 簡易ログイン(IDのみ) |
| **認証確認** | `api-client.ts` | **`/api/auth/verify`** | トークン検証 |
| **問題生成** | `api-client.ts` | `/api/problems/generate` | Task 1-4対応 |
| **文字起こし** | `api-client.ts` | `/api/speech/transcribe` | Whisper (Azure) |
| **音声合成** | `api-client.ts` | `/api/scoring/generate-speech` | TTS (Azure) |
| **採点** | `api-client.ts` | `/api/scoring/evaluate` | GPT-4 (Azure) |
| **履歴一覧** | `api-client.ts` | `/api/history` | クエリパラメータでフィルタ可能 |
| **履歴詳細** | `api-client.ts` | `/api/history/{id}` | 詳細画面用 |

※ 全てのエンドポイントは `/api` プレフィックスが付きます。

### 3.2 環境変数 (Environment Variables)

#### Backend (`tech0-gen-11-step3-2-py-24`)
| 変数名 | 説明 |
| :--- | :--- |
| `DATABASE_URL` | Neon接続文字列 |
| `AZURE_OPENAI_API_KEY` | AIサービス用キー |
| `AZURE_OPENAI_ENDPOINT` | AIサービスエンドポイント |
| `AZURE_API_VERSION` | `2024-12-01-preview` |
| `AZURE_GPT_DEPLOYMENT` | `gpt-5-chat` (デプロイ名) |
| `AZURE_WHISPER_DEPLOYMENT` | `whisper` (デプロイ名) |
| `AZURE_TTS_DEPLOYMENT` | `tts` (デプロイ名) |
| `ALLOWED_ORIGINS` | フロントエンドのURL (CORS許可設定)。厳密なURL指定推奨。 |
| `SCM_DO_BUILD_DURING_DEPLOYMENT` | `true` (必須。デプロイ時のビルド有効化) |
| `WEBSITES_PORT` | `8000` (FastAPIのポート) |

#### Frontend (`tech0-gen-11-step3-2-node-24`)
| 変数名 | 説明 |
| :--- | :--- |
| `NEXT_PUBLIC_API_URL` | バックエンドのURL (※GitHub Actionsのビルド時に埋め込まれるため、ポータル設定は補助的) |
| `PORT` | `8080` (Azureのデフォルト待機ポート) |

## 4. API仕様書 (更新版)

### Auth (認証)
*   **POST /api/auth/simple-login**
    *   概要: ユーザーID（メールアドレス等）のみで簡易ログイン
    *   Body: `{ "user_id": "user@example.com" }`
    *   Response: `{ "session_token": "...", "user_id": "..." }`

### Problems (問題)
*   **POST /api/problems/generate**
    *   概要: 問題生成
    *   Body: `{ "task_type": "task1", "user_id": "..." }`
    *   Response: `{ "reading_text": "...", "lecture_script": "...", "topic": "..." }`

### Speech (音声)
*   **POST /api/speech/transcribe**
    *   概要: 音声文字起こし
    *   Body: Multipart Form Data (`audio_file`)
    *   Response: `{ "transcript": "..." }`

### Scoring (採点)
*   **POST /api/scoring/evaluate**
    *   概要: 採点実行
    *   Body: `{ "problem_id": "...", "transcript": "..." }`
    *   Response: `{ "overall_score": 4.0, "feedback": {...} }`

### History (履歴)
*   **GET /api/history/{id}**
    *   概要: セッション詳細取得
    *   Response: `SessionDetailResponse` (スコア、フィードバック、音声URL含む)
